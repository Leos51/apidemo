name: API CI/CD Workflow

on: [push]

permissions:
  contents: read
  checks: write
  pull-requests: write

env:
  SONAR_PROJECT_KEY: Leos51_apidemo
  SONAR_ORGANIZATION: abraham-adouane

jobs:
  # ========================================
  # JOB 1 : TESTS UNITAIRES
  # ========================================
  unit-tests:
    name: ğŸ§ª Tests Unitaires
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Set up JDK ${{ vars.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ vars.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: ğŸ§ª Run Unit Tests
        run: mvn test -Dtest=*Test

      - name: ğŸ“Š Unit Test Report
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Unit Tests Report
          path: target/surefire-reports/*.xml
          reporter: java-junit
          fail-on-error: true

      - name: ğŸ“ˆ Upload Unit Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: target/surefire-reports/
          retention-days: 5

# ========================================
# JOB 2 : TESTS D'INTÃ‰GRATION
# ========================================
  integration-tests:
    name: ğŸ”— Tests d'IntÃ©gration
    runs-on: ubuntu-latest

  # Service MySQL pour les tests d'intÃ©gration
    services:
      mysql_server:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: springboot
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Set up JDK ${{ vars.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ vars.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: â³ Wait for MySQL
        run: |
          while ! mysqladmin ping -h"127.0.0.1" -P"3306" --silent; do
            sleep 1
          done

      - name: ğŸ“‚ Load Database Schema
        run: |
          echo "Loading database from dump"
          mysql -h 127.0.0.1 -P 3306 -u root -proot springboot < infra/mysql/dump/script.sql
          echo "âœ… Database loaded successfully!"


      - name: ğŸ”— Run Integration Tests
        run: |
          mvn verify -Dsurefire.skip=true \
            -Dspring.datasource.url=jdbc:mysql://localhost:3306/springboot \
            -Dspring.datasource.username=root \
            -Dspring.datasource.password=root

      - name: ğŸ“Š Integration Test Report
        if: always()
        uses: dorny/test-reporter@v2
        with:
          name: Integration Tests Report
          path: target/failsafe-reports/TEST-*.xml
          reporter: java-junit
          fail-on-error: true

      - name: ğŸ“ˆ Upload Integration Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: target/failsafe-reports/
          retention-days: 5

  # ========================================
  # JOB 3 : ANALYSE SONARCLOUD
  # ========================================
  sonarcloud:
    name: ğŸ” SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis

      - name: Set up JDK ${{ vars.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ vars.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: ğŸ” Cache SonarQube packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: ğŸ” SonarCloud Scan
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          mvn -B compile sonar:sonar \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.projectKey=${{ env.SONAR_PROJECT_KEY }} \
            -Dsonar.organization=${{ env.SONAR_ORGANIZATION }}

  # ========================================
  # JOB 4 : BUILD & PACKAGE
  # ========================================
  build:
    name: ğŸ”¨ Build & Package
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Set up JDK ${{ vars.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ vars.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: ğŸ”¨ Build with Maven
        run: mvn clean package -DskipTests

      - name: ğŸ“¦ Upload JAR Artifact
        uses: actions/upload-artifact@v4
        with:
          name: api-jar
          path: target/*.jar
          retention-days: 1

      - name: ğŸ“Š Build Info
        run: |
          echo "========================================="
          echo "ğŸ“¦ Build Information"
          echo "========================================="
          ls -lh target/*.jar
          echo "========================================="
          

  # ========================================
  # JOB 5 : BUILD & PUSH DOCKER IMAGE
  # ========================================
  docker:
    name: Build & push Docker Image
    runs-on: ubuntu-latest
    needs: [build, sonarcloud]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download jar Artifact
        uses: actions/download-artifact@v4
        with:
          name: api-jar
          path: target/


      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ·ï¸ Docker Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ vars.DOCKER_USERNAME }}/apidemo
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸ³ Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
  # ========================================
  # JOB 5 : DEPLOY NOTIFICATION
  # ========================================

  deploy:
    name: ğŸš€ Deploy notif
    runs-on: ubuntu-latest
    needs: [docker]
    steps:
      - name: ğŸ‰ Deployment Ready
        run: |
          echo "========================================="
          echo "ğŸ‰ API ready for deployment!"
          echo "========================================="

  # ========================================
  # JOB 7 : NOTIFICATION
  # ========================================
  Discord:
    name: ğŸ“¢ Discord Notification
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: Discord notification
        uses: sarisia/actions-status-discord@v1
        if: always()
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: ${{ job.status }}
          content: "Hey  ${{ github.actor }}"
          title: "API CI/CD Workflow"
          description: "Workflow completed!"
          username: GitHub Actions
          color: 0x0000ff