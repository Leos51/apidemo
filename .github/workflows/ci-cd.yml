name: API CI/CD Workflow

on: [push]

permissions:
  contents: read
  checks: write
  pull-requests: write

env:
  SONAR_PROJECT_KEY: Leos51_apidemo
  SONAR_ORGANIZATION: abraham-adouane

jobs:
  # ========================================
  # JOB 1 : TESTS UNITAIRES
  # ========================================
  unit-tests:
    name: üß™ Tests Unitaires
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: ‚òï Set up JDK ${{ vars.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ vars.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: üß™ Run Unit Tests
        run: mvn test -Dtest=*Test

      - name: üìä Unit Test Report
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Unit Tests Report
          path: target/surefire-reports/*.xml
          reporter: java-junit
          fail-on-error: true

      - name: üìà Upload Unit Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: target/surefire-reports/
          retention-days: 5

# ========================================
# JOB 2 : TESTS D'INT√âGRATION
# ========================================
  integration-tests:
    name: üîó Tests d'Int√©gration
    runs-on: ubuntu-latest

  # Service MySQL pour les tests d'int√©gration
    services:
      mysql_server:
        image: mysql:latest
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: springboot
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: ‚òï Set up JDK ${{ vars.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ vars.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: ‚è≥ Wait for MySQL
        run: |
          for i in {1..30}; do
          if mysqladmin ping -h 127.0.0.1 -P 3306 -u root -proot --silent; then
           echo "‚úÖ MySQL ready!"
           break
          fi
          sleep 2
          done

      - name: üìÇ Load Database Schema
        run: |
          echo "Loading database from dump"
          mysql -h 127.0.0.1 -P 3306 -u root -proot springboot < infra/mysql/dump/script.sql
          echo "‚úÖ Database loaded successfully!"

      - name: üîç Verify Database Content
        run: |
          echo "Checking database content..."
          mysql -h 127.0.0.1 -P 3306 -u root -proot springboot -e "SELECT * FROM user;"


      - name: üîó Run Integration Tests
        run: |
          mvn failsafe:integration-test failsafe:verify \
            -Dspring.datasource.url=jdbc:mysql://127.0.0.1:3306/springboot \
            -Dspring.datasource.username=root \
            -Dspring.datasource.password=root \
            -Dspring.jpa.hibernate.ddl-auto=validate

#      - name: üìä Integration Test Report
#        if: always()
#        uses: dorny/test-reporter@v2
#        with:
#          name: Integration Tests Report
#          path: target/failsafe-reports/TEST-*.xml
#          reporter: java-junit
#          fail-on-error: true
#
#      - name: üìà Upload Integration Test Results
#        if: always()
#        uses: actions/upload-artifact@v4
#        with:
#          name: integration-test-results
#          path: target/failsafe-reports/
#          retention-days: 5

  # ========================================
  # JOB 3 : ANALYSE SONARCLOUD
  # ========================================
  sonarcloud:
    name: üîç SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis

      - name: Set up JDK ${{ vars.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ vars.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: üîç Cache SonarQube packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: üîç SonarCloud Scan
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          mvn -B compile sonar:sonar \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.projectKey=${{ env.SONAR_PROJECT_KEY }} \
            -Dsonar.organization=${{ env.SONAR_ORGANIZATION }}

  # ========================================
  # JOB 4 : BUILD & PACKAGE
  # ========================================
  build:
    name: üî® Build & Package
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: ‚òï Set up JDK ${{ vars.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ vars.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: üî® Build with Maven
        run: mvn clean package -DskipTests

      - name: üì¶ Upload JAR Artifact
        uses: actions/upload-artifact@v4
        with:
          name: api-jar
          path: target/*.jar
          retention-days: 1

      - name: üìä Build Info
        run: |
          echo "========================================="
          echo "üì¶ Build Information"
          echo "========================================="
          ls -lh target/*.jar
          echo "========================================="
          

  # ========================================
  # JOB 5 : BUILD & PUSH DOCKER IMAGE
  # ========================================
  docker:
    name: Build & push Docker Image
    if: ${{ github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    needs: [build, sonarcloud]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

#      - name: Set up QEMU
#        uses: docker/setup-qemu-action@v3
#
#      - name: Set up Docker Buildx
#        uses: docker/setup-buildx-action@v3

      - name: Download jar Artifact
        uses: actions/download-artifact@v4
        with:
          name: api-jar
          path: target/

#      - name: List files in the repo
#        run: ls ${{ github.workspace }}

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}


      - name: üê≥ Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: true
          tags: ${{vars.DOCKER_USERNAME}}/api:latest



      - run: echo "üî• This job status is ${{ job.status }}

  # ========================================
  # JOB 5 : DEPLOY NOTIFICATION
  # ========================================

  deploy:
    name: üöÄ Deploy notif
    runs-on: ubuntu-latest
    needs: [docker]
    steps:
      - name: üéâ Deployment Ready
        run: |
          echo "========================================="
          echo "üéâ API ready for deployment!"
          echo "========================================="

  # ========================================
  # JOB 7 : NOTIFICATION
  # ========================================
  Discord:
    name: üì¢ Discord Notification
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: Discord notification
        uses: sarisia/actions-status-discord@v1
        if: always()
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: ${{ job.status }}
          content: "Hey  ${{ github.actor }}"
          title: "API CI/CD Workflow"
          description: "Workflow completed!"
          username: GitHub Actions
          color: 0x0000ff